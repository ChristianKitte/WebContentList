@using WebContentList.Data

@page "/contentlist"

@inject SubjectsService SubjectsService
@inject ContentsService ContentsService

<h3>Alle Inhalte</h3>

<ConfirmDeleteDialog @ref=_confirmDialog
                     ConfirmationChanged="ConfirmDelete_Click"
                     ConfirmationMessage="Soll das Element wirklich gelöscht werden?">
</ConfirmDeleteDialog>

@if (_subjects == null || _content == null)
{
    <p>Loading...</p>
}
else
{
    <div>
        <a class="btn btn-success" href="addcontent">Neuer Inhalt...</a>
    </div>

    <div>
        <select name="Gruppe">
            <option value="-1" @onclick=@(() => GetVideosByGroup(-1)) @onclick:preventDefault="true">Alle</option>

            @foreach (var group in _content)
            {
                <option value="@group.SubjectId" @onclick=@(() => GetVideosByGroup(group.SubjectId)) @onclick:preventDefault="true">@group.Name</option>
            }
        </select>
    </div>

    <div>
        <ul class="list-group list-group-flush">
            <Virtualize Items="_subjects" Context="subject">
                <li class="list-group-item">
                    <div>
                        @if (subject.ShowPreview)
                        {
                            <iframe width="450" height="300" src="@subject.Url" allowfullscreen></iframe>
                        }
                        else
                        {
                            <p>@subject.Url</p>
                        }

                        <p>@subject.Name</p>
                        <p>@subject.Description</p>

                        <div class="col-4">
                            <a class="btn btn-primary" href="@subject.Url">In neuer Seite öffnen..</a>
                            <a class="btn btn-secondary" href="editcontent/@subject.ContentId">Bearbeiten</a>
                            <a class="btn btn-danger" @onclick="() => Delete_Click(subject.ContentId)">Löschen</a>
                        </div>
                    </div>
                </li>
            </Virtualize>
        </ul>
    </div>
}


@code {
    private List<Subject>? _content;
    private List<Content>? _subjects;

    Content? curContent = null;
    int curGroupID = -1;

    private ConfirmDeleteDialog? _confirmDialog { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        _content = await SubjectsService.GetSubjectList();
        _subjects = await ContentsService.GetContentList();
    }

    private async Task GetVideosByGroup(int groupId)
    {
        curGroupID = groupId;

        if (groupId == -1)
        {
            _subjects = await ContentsService.GetContentList();
        }
        else
        {
            _subjects = await ContentsService.GetContentListBySubject(groupId);
        }
    }

    protected async void Delete_Click(int id)
    {
        curContent = await ContentsService.GetContentById(id);
        _confirmDialog?.Show();
    }

    protected async Task ConfirmDelete_Click(bool deleteConfirmed)
    {
        if (deleteConfirmed && curContent != null)
        {
            await ContentsService.DeleteContent(curContent);
            await GetVideosByGroup(curGroupID);

            StateHasChanged();
        }
    }
}